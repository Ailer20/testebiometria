<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Presença por Biometria</title>
</head>
<body>

    <h1>Registro de Presença</h1>
    <button id="biometriaBtn">Registrar Presença com Biometria</button>
    <div id="presencaLog"></div>

    <script>
        // Função para verificar suporte biométrico usando a WebAuthn API
        async function verificarSuporteBiometria() {
            if ('credentials' in navigator && 'get' in navigator.credentials) {
                return true;
            }
            return false;
        }

        // Função para gerar um desafio aleatório
        function gerarDesafio() {
            const desafio = new Uint8Array(32);
            window.crypto.getRandomValues(desafio);
            return desafio;
        }

        // Função para criar credenciais biométricas
        async function criarCredenciais() {
            try {
                // Gerar um desafio e opções de criação
                const publicKeyCredentialCreationOptions = {
                    challenge: gerarDesafio(),
                    rp: {
                        name: "Presença com Biometria"
                    },
                    user: {
                        id: new TextEncoder().encode("usuario_1"), // ID do usuário, geralmente é um ID único
                        name: "Aluno Teste",
                        displayName: "Aluno Teste"
                    },
                    pubKeyCredParams: [{
                        type: "public-key",
                        alg: -7 // Algoritmo de assinatura (algoritmo de ECDSA)
                    }],
                    timeout: 60000,
                    attestation: "direct"
                };

                // Registrar credenciais biométricas
                const credencial = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                console.log("Credencial criada com sucesso:", credencial);

                alert('Credenciais biométricas criadas com sucesso!');
            } catch (error) {
                console.error('Erro ao criar credenciais biométricas:', error);
                alert('Falha ao criar credenciais biométricas.');
            }
        }

        // Função para autenticar biometria
        async function autenticarBiometria() {
            try {
                const publicKeyCredentialRequestOptions = {
                    challenge: gerarDesafio(),
                    timeout: 60000,
                    userVerification: "required" // Força a verificação biométrica
                };

                // Solicitar autenticação usando WebAuthn API
                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                if (assertion) {
                    const horario = new Date().toLocaleString('pt-BR');
                    const presencaLog = document.getElementById('presencaLog');
                    presencaLog.innerHTML += `<p>Presença registrada às ${horario}</p>`;
                    alert('Presença registrada com sucesso!');
                }
            } catch (error) {
                console.error('Falha na autenticação biométrica:', error);
                alert('Autenticação falhou ou foi cancelada.');
            }
        }

        // Função chamada ao clicar no botão
        async function registrarPresenca() {
            const suporteBiometria = await verificarSuporteBiometria();

            if (suporteBiometria) {
                console.log('Dispositivo com suporte biométrico detectado');
                
                // Verifique se o dispositivo tem credenciais biométricas cadastradas
                const credenciais = await navigator.credentials.get({ publicKey: {} });

                if (credenciais) {
                    // Se já houver credenciais, apenas autentica
                    await autenticarBiometria();
                } else {
                    // Caso não haja credenciais, cria novas
                    await criarCredenciais();
                }
            } else {
                alert('Este dispositivo não suporta autenticação biométrica.');
            }
        }

        // Adiciona o evento ao botão após o carregamento da página
        document.addEventListener('DOMContentLoaded', function() {
            const botao = document.getElementById('biometriaBtn');
            botao.addEventListener('click', registrarPresenca);
        });
    </script>

</body>
</html>
