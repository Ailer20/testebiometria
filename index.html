<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Presença por Biometria</title>
</head>
<body>

    <h1>Registro de Presença</h1>
    <button id="biometriaBtn">Registrar Presença com Biometria</button>
    <div id="presencaLog"></div>

    <script>
        // Função para verificar se o navegador suporta a API WebAuthn
        async function verificarSuporteBiometria() {
            if (navigator.credentials && navigator.credentials.get) {
                return true;
            }
            alert('Este navegador ou dispositivo não tem suporte para autenticação biométrica.');
            return false;
        }

        // Função para gerar um desafio aleatório (usado para criar e autenticar credenciais)
        function gerarDesafio() {
            const desafio = new Uint8Array(32);
            window.crypto.getRandomValues(desafio);
            return desafio;
        }

        // Função para criar credenciais biométricas (caso não existam)
        async function criarCredenciais() {
            try {
                const publicKeyCredentialCreationOptions = {
                    challenge: gerarDesafio(),
                    rp: {
                        name: "Presença com Biometria"
                    },
                    user: {
                        id: new TextEncoder().encode("usuario_1"), // ID do usuário (pode ser um ID único)
                        name: "Aluno Teste",
                        displayName: "Aluno Teste"
                    },
                    pubKeyCredParams: [{
                        type: "public-key",
                        alg: -7 // Algoritmo ECDSA
                    }],
                    timeout: 60000,
                    attestation: "direct"
                };

                const credencial = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions
                });

                console.log("Credencial criada com sucesso:", credencial);
                alert('Credenciais biométricas criadas com sucesso!');
            } catch (error) {
                console.error('Erro ao criar credenciais biométricas:', error);
                alert('Falha ao criar credenciais biométricas.');
            }
        }

        // Função para autenticar a biometria
        async function autenticarBiometria() {
            try {
                const publicKeyCredentialRequestOptions = {
                    challenge: gerarDesafio(),
                    timeout: 60000,
                    userVerification: "required" // Exige que a autenticação seja feita com biometria
                };

                const assertion = await navigator.credentials.get({
                    publicKey: publicKeyCredentialRequestOptions
                });

                if (assertion) {
                    const horario = new Date().toLocaleString('pt-BR');
                    const presencaLog = document.getElementById('presencaLog');
                    presencaLog.innerHTML += `<p>Presença registrada às ${horario}</p>`;
                    alert('Presença registrada com sucesso!');
                }
            } catch (error) {
                console.error('Falha na autenticação biométrica:', error);
                alert('Autenticação falhou ou foi cancelada.');
            }
        }

        // Função chamada ao clicar no botão
        async function registrarPresenca() {
            // Verifica se o dispositivo tem suporte a biometria
            const suporteBiometria = await verificarSuporteBiometria();

            if (suporteBiometria) {
                console.log('Dispositivo com suporte biométrico detectado');

                // Tentamos obter credenciais registradas
                try {
                    const credenciais = await navigator.credentials.get({ publicKey: {} });

                    if (credenciais) {
                        console.log("Credenciais existentes encontradas");
                        // Se houver credenciais registradas, fazemos a autenticação
                        await autenticarBiometria();
                    } else {
                        console.log("Nenhuma credencial existente encontrada, criando novas...");
                        // Se não houver credenciais, criamos novas
                        await criarCredenciais();
                    }
                } catch (error) {
                    console.error('Erro ao buscar credenciais existentes:', error);
                    alert('Falha ao verificar credenciais biométricas.');
                }
            }
        }

        // Adiciona o evento ao botão após o carregamento da página
        document.addEventListener('DOMContentLoaded', function() {
            const botao = document.getElementById('biometriaBtn');
            botao.addEventListener('click', registrarPresenca);
        });
    </script>

</body>
</html>

